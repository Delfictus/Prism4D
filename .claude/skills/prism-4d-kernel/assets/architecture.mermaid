```mermaid
flowchart TB
    subgraph Input["Input Layer"]
        PDB["PDB Structure<br/>6M0J + Mutations"]
        GISAID["GISAID Frequencies<br/>12 Countries × 700 Dates"]
        DMS["DMS Escape Matrix<br/>Bloom Lab Data"]
    end

    subgraph Rust["Rust API Layer"]
        Batch["PackedBatch<br/>atoms_packed, ca_indices_packed"]
        Desc["BatchStructureDesc<br/>offsets per structure"]
        Config["MegaFusedConfig<br/>mode, thresholds"]
    end

    subgraph GPU["GPU Kernel (mega_fused_batch_detection_prism4d)"]
        direction TB
        S1["Stage 1: Contact Network<br/>12Å cutoff, Gaussian decay"]
        S2["Stage 2: Geometry<br/>burial, curvature, shape"]
        S3["Stage 3: TDA Features<br/>48-dim topology"]
        S4["Stage 4: Dendritic Reservoir<br/>32-dim neuromorphic"]
        S5["Stage 5: Network Analysis<br/>centrality, clustering"]
        S6["Stage 6: Consensus Fusion<br/>weighted combination"]
        S7["Stage 7: FITNESS MODULE<br/>ΔΔG_bind, ΔΔG_stab, expression, transmit"]
        S8["Stage 8: CYCLE MODULE<br/>phase, emergence_prob, time_to_peak"]
        S65["Stage 6.5: Feature Combination<br/>101-dim output"]
        
        S1 --> S2 --> S3 --> S4 --> S5 --> S6 --> S7 --> S8 --> S65
    end

    subgraph Features["101-dim Feature Vector"]
        F1["0-47: TDA"]
        F2["48-79: Reservoir"]
        F3["80-91: Physics"]
        F4["92-95: Fitness"]
        F5["96-100: Cycle"]
    end

    subgraph RL["FluxNet RL Layer"]
        State["VEState<br/>escape, freq, gamma, growth_potential"]
        Disc["Discretize<br/>→ 256 states"]
        QTable["Q-Table<br/>256 × 2"]
        Action["Action<br/>RISE / FALL"]
        
        State --> Disc --> QTable --> Action
    end

    subgraph Output["Output"]
        Pred["Prediction<br/>RISE or FALL"]
        Acc["Accuracy<br/>Target: >92%"]
    end

    PDB --> Batch
    GISAID --> Config
    DMS --> State
    Batch --> Desc
    Desc --> GPU
    Config --> GPU
    GPU --> Features
    Features --> State
    Action --> Pred
    Pred --> Acc

    style S7 fill:#e1f5fe
    style S8 fill:#e1f5fe
    style F4 fill:#e1f5fe
    style F5 fill:#e1f5fe
```

## Pipeline Data Flow

```
14,917 Structures (12 countries × ~1,200 lineages)
         ↓
    PackedBatch
         ↓
   ┌─────────────────────────────────────┐
   │     Single GPU Kernel Launch        │
   │   (one block per structure)         │
   │                                     │
   │  atoms_packed ──┐                   │
   │  ca_indices ────┼──→ Stages 1-6    │
   │  conservation ──┤                   │
   │  bfactor ───────┤                   │
   │  burial ────────┘                   │
   │                                     │
   │  residue_types ──→ Stage 7         │
   │  gisaid_freq ────┼──→ Stage 8      │
   │  gisaid_vel ─────┘                  │
   │                                     │
   │  combined_features ←── Stage 6.5   │
   └─────────────────────────────────────┘
         ↓
   101-dim per residue
         ↓
   Average features 92-100 across RBD
         ↓
   VEState (escape, freq, gamma, ...)
         ↓
   Discretize → Q-Table Lookup
         ↓
   RISE/FALL Prediction
```

## Win Condition Thresholds

| Metric | Threshold | Status |
|--------|-----------|--------|
| Kernel Time | <60s for 14,917 structures | ⬜ |
| Test Accuracy | >92.0% mean | ⬜ |
| Train Accuracy | >85% (convergence) | ⬜ |
| No Hardcoded Weights | VASIL γ formula NOT used | ✅ |
