STAGES 1-7 COMPLETE FILE MAPPING (Fully Functional)

  ---
  1. CUDA KERNEL SOURCE FILES

  Primary Kernel: mega_fused_batch.cu

  Location: crates/prism-gpu/src/kernels/mega_fused_batch.cu
  Size: 136 KB
  Last Modified: Dec 13 03:22

  Stage Functions Implemented:
  // Stage 1: Lines 575-648
  __device__ void batch_stage1_distance_contact(...)

  // Stage 2: Lines 654-682 + 684-838
  __device__ void batch_stage2_local_features(...)
  __device__ void batch_stage2b_geometry_features(...)
  __device__ void batch_stage2c_tda_features(...)

  // Stage 3: Lines 840-1070
  __device__ void batch_stage3_network_centrality(...)

  // Stage 4: Lines 1142-1321
  __device__ void batch_stage4_dendritic_reservoir(...)

  // Stage 5: Lines 1323-1420
  __device__ void batch_stage5_consensus(...)

  // Stage 6: Lines 1422-1475
  __device__ void batch_stage6_kempe_refinement(...)

  // Stage 7: Lines 1483-1536
  __device__ void batch_stage7_fitness_features(...)
  __device__ void batch_stage7_global_clustering(...)  // Lines 1677-1768

  Constant Memory Arrays (Embedded in .cu):
  __constant__ float c_hydrophobicity[20]          // Line 526-531 (20 amino acids)
  __constant__ float c_residue_volume[20]          // Line 534-539
  __constant__ float c_tau_decay[4]                // Line 157-159 (compartments)
  __constant__ float c_compartment_weights[4]      // Line 162-164

  Header Dependencies:

  Location: crates/prism-gpu/src/kernels/prism_numerics.cuh
  Size: 8.4 KB
  Purpose: Compensated accumulation (used in Stage 10, not Stages 1-7)
  Used by Stages 1-7: ❌ NO (only included for later stages)

  ---
  2. PTX COMPILATION ARTIFACTS

  Compiled Kernel: mega_fused_batch.ptx

  Location: target/ptx/mega_fused_batch.ptx
  Size: 622 KB
  Last Compiled: Dec 13 03:24
  Generated From: mega_fused_batch.cu

  Compilation Command:
  /usr/local/cuda-12.6/bin/nvcc \
    -ptx \
    -arch=sm_86 \
    -O3 \
    --use_fast_math \
    -o target/ptx/mega_fused_batch.ptx \
    crates/prism-gpu/src/kernels/mega_fused_batch.cu

  Exported Kernel Functions:
  .entry mega_fused_batch_detection(...)   # Main kernel (Stages 1-11)
  .entry mega_fused_batch_screening(...)   # Minimal iterations
  .entry mega_fused_batch_training(...)    # Reservoir export

  CUDA Dependencies:
  - /usr/local/cuda-12.6/bin/nvcc (compiler)
  - /usr/local/cuda-12.6/include/cuda_runtime.h
  - /usr/local/cuda-12.6/include/cooperative_groups.h

  ---
  3. RUST HOST CODE (GPU Launch)

  A. GPU Executor: mega_fused_batch.rs

  Location: crates/prism-gpu/src/mega_fused_batch.rs
  Purpose: Load PTX, allocate buffers, launch kernels
  Key Functions:

  // Lines 475-565: Initialize GPU and load PTX
  impl MegaFusedBatchGpu {
      pub fn new(context: Arc<CudaContext>, ptx_dir: &Path) -> Result<Self>
      // Loads: target/ptx/mega_fused_batch.ptx
      // Extracts: mega_fused_batch_detection function
  }

  // Lines 589-967: Main batch execution
  pub fn detect_pockets_batch(
      &mut self,
      batch: &PackedBatch,
      config: &MegaFusedConfig,
  ) -> Result<BatchOutput>
  // Stages 1-7 Data Flow:
  // 1. Upload: atoms, CA indices, conservation, bfactor, burial, residue_types
  // 2. Launch: mega_fused_batch_detection kernel (grid: n_structures, block: 256)
  // 3. Download: consensus, confidence, signal_mask, pocket_assignment, centrality, features[0-95]

  Buffer Allocations (Stages 1-7):
  // Lines 636-678
  d_atoms           // Line 636: total_atoms * 3 * f32
  d_ca_indices      // Line 648: total_residues * i32
  d_conservation    // Line 650: total_residues * f32
  d_bfactor         // Line 652: total_residues * f32
  d_burial          // Line 654: total_residues * f32
  d_residue_types   // Line 658: total_residues * i32 (PRISM>4D for Stage 7)
  d_consensus       // Line 662: total_residues * f32 (Stage 5 output)
  d_centrality      // Line 670: total_residues * f32 (Stage 3 output)
  d_combined_features // Line 674: total_residues * 136 * f32 (includes 0-95)

  Critical Structs:
  // Line 247-268: Input batch container
  pub struct PackedBatch {
      descriptors: Vec<BatchStructureDesc>,    // Structure offsets
      atoms_packed: Vec<f32>,                  // ✅ REAL coordinates
      ca_indices_packed: Vec<i32>,             // ✅ REAL CA atoms
      conservation_packed: Vec<f32>,           // ✅ REAL scores
      bfactor_packed: Vec<f32>,                // ✅ REAL flexibility
      burial_packed: Vec<f32>,                 // ✅ REAL burial depth
      residue_types_packed: Vec<i32>,          // ✅ REAL amino acids (0-19)
  }

  // Line 35-47: Structure descriptor (matches CUDA)
  #[repr(C, align(16))]
  pub struct BatchStructureDesc {
      pub atom_offset: i32,
      pub residue_offset: i32,
      pub n_atoms: i32,
      pub n_residues: i32,
  }

  B. Data Packing: main.rs

  Location: crates/prism-ve-bench/src/main.rs
  Function: build_mega_batch() (Lines 972-1147)

  Real Data Loaded into PackedBatch:
  all_inputs.push(StructureInput {
      id: format!("{}_{}_{}", country, lineage, date),
      atoms: structure.atoms.clone(),           // ✅ From PDB + mutations
      ca_indices: structure.ca_indices.clone(), // ✅ From PDB parsing
      conservation: structure.conservation.clone(), // ✅ From PDB
      bfactor: structure.bfactor.clone(),       // ✅ From PDB
      burial: structure.burial.clone(),         // ✅ From PDB
      residue_types: structure.residue_types.clone(), // ✅ From PDB (20 AA codes)
  });

  C. Structure Loading: gpu_benchmark.rs

  Location: crates/prism-ve-bench/src/gpu_benchmark.rs
  Function: load_variant_structure() (Lines 718-891)

  Real Structure Generation:
  // Line 758-767: Load reference PDB
  let base_structure = init_reference_structure()?;  // 6M0J Spike RBD

  // Line 774-838: Apply mutations
  let mut mutated_coords = base_structure.atoms.clone();
  for mutation in &mutations_str {
      apply_mutation(mutation, &mut mutated_coords, ...);  // ✅ REAL mutations
  }

  // Line 845-862: Compute conservation (sequence-based)
  let conservation = compute_conservation_scores(...);     // ✅ REAL scores

  // Line 868-880: Compute burial (coordinate-based)
  let burial = compute_burial_scores(...);                 // ✅ REAL burial depth

  D. PDB Parser: pdb_parser.rs

  Location: crates/prism-ve-bench/src/pdb_parser.rs
  Function: PdbStructure::from_file() (Lines 50-200)

  Real PDB Parsing:
  // Lines 50-200: Parse ATOM records
  for line in file.lines() {
      if line.starts_with("ATOM") {
          let x = parse_f32(&line[30..38]);  // ✅ REAL coordinates
          let y = parse_f32(&line[38..46]);
          let z = parse_f32(&line[46..54]);
          let bfactor = parse_f32(&line[60..66]); // ✅ REAL B-factors
          let residue_name = &line[17..20];       // ✅ REAL amino acid
      }
  }

  ---
  4. RUNTIME BINARIES

  Main Executable: vasil-benchmark

  Location: target/release/vasil-benchmark
  Size: 3.1 MB
  Last Built: Dec 13 04:04
  Built From: crates/prism-ve-bench/

  Rust Crate Dependencies:
  prism-ve-bench (binary crate)
  ├── prism-gpu (library crate)
  │   └── mega_fused_batch.rs  # GPU executor
  ├── cudarc 0.18.1            # CUDA driver API
  ├── chrono                   # Date handling
  └── anyhow                   # Error handling

  Compilation:
  PATH="...rustup/stable-x86_64-unknown-linux-gnu/bin:/usr/bin:$PATH" \
  CUDA_HOME=/usr/local/cuda-12.6 \
  cargo build --release -p prism-ve-bench --features cuda

  ---
  5. INPUT DATA FILES (Stages 1-7)

  A. Reference Structure

  File: data/spike_rbd_6m0j.pdb
  Size: 571 KB
  Source: PDB ID 6M0J (SARS-CoV-2 Spike RBD in complex with ACE2)
  Used by: gpu_benchmark.rs:404 (REFERENCE_PDB_PATH)

  Contains:
  - ✅ 6,571 atoms (Spike RBD chain E)
  - ✅ 194 residues (residues 331-524)
  - ✅ Real CA coordinates (x, y, z)
  - ✅ Real B-factors (thermal fluctuation)
  - ✅ Amino acid sequence (single-letter codes)

  B. VASIL Frequency Data

  Location: /mnt/f/VASIL_Data/ByCountry/{Country}/results/
  Files per Country:
  Daily_Lineages_Freq_1_percent.csv  # ✅ Loaded (data_loader.rs:39)

  Loaded by: main.rs:90 → AllCountriesData::load_all_vasil_countries()
  Contains:
  - ✅ Lineage names (e.g., "BA.1", "XBB.1.5")
  - ✅ Daily frequencies per lineage (0-1)
  - ✅ Date range per country

  Used for:
  - Building metadata[idx].frequency (CPU metadata, NOT passed to GPU Stages 1-7)
  - Temporal holdout split (<2022-06-01 train, >=2022-06-01 test)

  C. VASIL Mutation Data

  Location: /mnt/f/VASIL_Data/ByCountry/{Country}/results/mutation_data/
  Files per Country:
  mutation_lists.csv  # ✅ Loaded (data_loader.rs:364)

  Loaded by: main.rs:90 → AllCountriesData::load_all_vasil_countries()
  Contains:
  - ✅ Lineage-specific mutations (e.g., "N501Y", "E484K")
  - ✅ Spike RBD site numbers (331-531)

  Used for:
  - gpu_benchmark.rs:774-838 → Applies mutations to 6M0J structure
  - Result: Real mutated coordinates for each lineage

  D. VASIL DMS Escape Data

  Location: /mnt/f/VASIL_Data/ByCountry/{Country}/results/epitope_data/
  Files per Country:
  dms_per_ab_per_site.csv  # ✅ Loaded (data_loader.rs:146)

  Loaded by: main.rs:90 → AllCountriesData::load_all_vasil_countries()
  Contains:
  - ✅ Antibody escape scores per RBD site
  - ✅ 10 epitope groups (A, B, C, D1, D2, E12, E3, F1, F2, F3)

  Used for:
  - gpu_benchmark.rs:get_lineage_epitope_escape_scores() → CPU metadata
  - NOT passed to GPU Stages 1-7 (only used in Stage 9, which gets nullptr)

  ---
  6. EXECUTION FLOW (Stages 1-7 Only)

  Runtime Execution Path:

  1. Binary Launch
     target/release/vasil-benchmark

  2. Load VASIL Data (CPU)
     main.rs:90 → AllCountriesData::load_all_vasil_countries()
     ├── Daily_Lineages_Freq_1_percent.csv (12 countries)
     ├── mutation_lists.csv (12 countries)
     └── dms_per_ab_per_site.csv (12 countries)

  3. Load Reference PDB (CPU)
     main.rs:107 → init_reference_structure()
     └── data/spike_rbd_6m0j.pdb → PdbStructure (194 residues, 6571 atoms)

  4. Build Mutated Structures (CPU)
     main.rs:972-1147 → build_mega_batch()
     ├── For each lineage: apply mutations to 6M0J
     ├── gpu_benchmark.rs:774-838 → apply_mutation()
     └── PackedBatch: 12,262 structures (atoms, CA, conservation, bfactor, burial, res_types)

  5. Initialize GPU (Rust)
     main.rs:199-203 → CudaContext::new(0)
     └── MegaFusedBatchGpu::new(context, "target/ptx")
         mega_fused_batch.rs:478-502
         └── Loads: target/ptx/mega_fused_batch.ptx
         └── Extracts: mega_fused_batch_detection kernel function

  6. GPU Execution (CUDA)
     main.rs:212 → gpu.detect_pockets_batch(packed_batch, config)
     mega_fused_batch.rs:589-967
     ├── Upload to GPU (Lines 741-754):
     │   ├── atoms_packed         (total_atoms * 3 * f32)
     │   ├── ca_indices_packed    (total_residues * i32)
     │   ├── conservation_packed  (total_residues * f32)
     │   ├── bfactor_packed       (total_residues * f32)
     │   ├── burial_packed        (total_residues * f32)
     │   └── residue_types_packed (total_residues * i32)  # For Stage 7!
     │
     ├── Launch Kernel (Line 886):
     │   Grid: (12262, 1, 1)  # One block per structure
     │   Block: (256, 1, 1)    # 256 threads per block
     │   Kernel: mega_fused_batch_detection<<<12262, 256>>>
     │
     │   GPU Execution (mega_fused_batch.cu:2478-2614):
     │   └── Each block processes one structure through Stages 1-7:
     │       ├── Stage 1: Distance/contact from REAL coordinates
     │       ├── Stage 2: Load REAL conservation, bfactor, burial
     │       ├── Stage 2b: Geometry (HSE, concavity, pocket depth) from coordinates
     │       ├── Stage 2c: TDA (topology) from contact graph
     │       ├── Stage 3: Network centrality via power iteration
     │       ├── Stage 4: Dendritic reservoir with REAL features
     │       ├── Stage 5: Consensus scoring
     │       ├── Stage 6: Kempe coloring refinement
     │       └── Stage 7: Fitness from REAL residue_types + burial + centrality
     │
     ├── Synchronize (Line 893)
     │
     └── Download from GPU (Lines 913-924):
         ├── consensus_scores      (total_residues * f32)
         ├── confidence            (total_residues * i32)
         ├── centrality            (total_residues * f32)
         └── combined_features     (total_residues * 136 * f32)
             └── Features 0-95: ✅ REAL from Stages 1-7
             └── Features 96-135: ❌ MOCK from Stages 8-11

  B. Data Loading: data_loader.rs

  Location: crates/prism-ve-bench/src/data_loader.rs
  Functions:
  // Line 31-130: Load frequency data
  GisaidFrequencies::load_from_vasil(vasil_data_dir, country)

  // Line 137-350: Load DMS escape data
  DmsEscapeData::load_from_vasil(vasil_data_dir, country)

  // Line 355-465: Load mutation lists
  LineageMutations::load_from_vasil(vasil_data_dir, country)

  // Line 470-540: Load all 12 countries
  AllCountriesData::load_all_vasil_countries(vasil_data_dir)

  C. PDB Operations: pdb_parser.rs

  Location: crates/prism-ve-bench/src/pdb_parser.rs
  Functions:
  // Line 50-200: Parse PDB file
  PdbStructure::from_file(path)
  // Extracts: ATOM records → coords, bfactor, residue names

  // Line 250-350: Apply mutations
  apply_mutation(mutation_str, coords, ...)
  // Modifies: CA coordinates based on mutation type

  D. Structure Generation: gpu_benchmark.rs

  Location: crates/prism-ve-bench/src/gpu_benchmark.rs
  Functions:
  // Line 416-450: Load 6M0J reference
  init_reference_structure() -> PdbStructure

  // Line 460-530: Initialize mutation cache
  init_mutations_cache(all_countries_data)

  // Line 718-891: Generate mutated structure
  load_variant_structure(lineage) -> VariantStructure
  ├── Get mutations for lineage
  ├── Apply to 6M0J base structure
  ├── Compute conservation scores
  └── Compute burial scores

  ---
  7. DEPENDENCY GRAPH (Stages 1-7)

  ┌─────────────────────────────────────────────────────────────────┐
  │ COMPILATION PHASE                                                │
  └─────────────────────────────────────────────────────────────────┘

  mega_fused_batch.cu (136 KB)
  ├── Includes: prism_numerics.cuh (8.4 KB)
  ├── Includes: <cuda_runtime.h>
  ├── Includes: <cooperative_groups.h>
  │
  ├── [nvcc compiler]
  │   ├── /usr/local/cuda-12.6/bin/nvcc
  │   ├── Flags: -ptx -arch=sm_86 -O3 --use_fast_math
  │   └── Output: target/ptx/mega_fused_batch.ptx (622 KB)
  │
  └── Constant Memory (embedded in PTX):
      ├── c_hydrophobicity[20]        # Stages 7
      ├── c_residue_volume[20]        # Stage 7
      ├── c_tau_decay[4]              # Stage 4
      └── c_compartment_weights[4]    # Stage 4

  ┌─────────────────────────────────────────────────────────────────┐
  │ RUNTIME PHASE                                                    │
  └─────────────────────────────────────────────────────────────────┘

  DATA LOADING (CPU):
    /mnt/f/VASIL_Data/ByCountry/*/results/
    ├── Daily_Lineages_Freq_1_percent.csv (12 countries)  # ✅ Loaded
    ├── mutation_lists.csv (12 countries)                 # ✅ Loaded
    └── dms_per_ab_per_site.csv (12 countries)            # ✅ Loaded

    data/spike_rbd_6m0j.pdb (571 KB)                      # ✅ Loaded

  STRUCTURE GENERATION (CPU):
    main.rs → build_mega_batch()
    ├── pdb_parser.rs → parse 6M0J
    └── gpu_benchmark.rs → apply mutations → 12,262 mutated structures
        ├── atoms (x,y,z coordinates)                     # ✅ REAL
        ├── ca_indices (CA atom indices)                  # ✅ REAL
        ├── conservation (sequence conservation)          # ✅ REAL
        ├── bfactor (thermal flexibility)                 # ✅ REAL
        ├── burial (solvent burial depth)                 # ✅ REAL
        └── residue_types (0-19 amino acid codes)         # ✅ REAL

  GPU INITIALIZATION (Rust + CUDA):
    mega_fused_batch.rs::new()
    └── Load: target/ptx/mega_fused_batch.ptx
        └── Extract: mega_fused_batch_detection kernel

  GPU EXECUTION (CUDA):
    mega_fused_batch.rs::detect_pockets_batch()
    ├── Upload PackedBatch → GPU (atoms, CA, conservation, bfactor, burial, res_types)
    ├── Launch: mega_fused_batch_detection<<<12262, 256>>>
    │   └── For each structure in parallel:
    │       ├── Stage 1: Distance/Contact from REAL coords          # ✅
    │       ├── Stage 2: Local features from REAL bfactor/burial    # ✅
    │       ├── Stage 2b: Geometry from REAL coordinates            # ✅
    │       ├── Stage 2c: TDA from contact graph                    # ✅
    │       ├── Stage 3: Network centrality                         # ✅
    │       ├── Stage 4: Reservoir with REAL features               # ✅
    │       ├── Stage 5: Consensus                                  # ✅
    │       ├── Stage 6: Kempe refinement                           # ✅
    │       └── Stage 7: Fitness from REAL residue_types            # ✅
    │           └── Lookups: c_hydrophobicity[res_type]
    │           └── Lookups: c_residue_volume[res_type]
    │
    └── Download: combined_features[0-95] (REAL), [96-135] (MOCK)

  FEATURE EXTRACTION (CPU):
    main.rs:1174-1184 → Extract features 92-95 (Fitness)
    └── Averages across residues for per-structure predictions

  ---
  COMPLETE FILE LIST (Stages 1-7 Functionality)

  Source Files:

  ✅ crates/prism-gpu/src/kernels/mega_fused_batch.cu         (136 KB) - CUDA kernel
  ✅ crates/prism-gpu/src/kernels/prism_numerics.cuh          (8.4 KB) - Header
  ✅ crates/prism-gpu/src/mega_fused_batch.rs                 (...)    - Rust GPU launcher
  ✅ crates/prism-ve-bench/src/main.rs                        (...)    - Main orchestration
  ✅ crates/prism-ve-bench/src/gpu_benchmark.rs               (...)    - Structure loading
  ✅ crates/prism-ve-bench/src/pdb_parser.rs                  (...)    - PDB parsing
  ✅ crates/prism-ve-bench/src/data_loader.rs                 (...)    - VASIL CSV loading

  Compiled Artifacts:

  ✅ target/ptx/mega_fused_batch.ptx                          (622 KB) - Compiled kernel
  ✅ target/release/vasil-benchmark                           (3.1 MB) - Executable binary
  ✅ target/release/libprism_gpu.rlib                         (...)    - Rust library

  Runtime Data:

  ✅ data/spike_rbd_6m0j.pdb                                  (571 KB) - Reference structure
  ✅ /mnt/f/VASIL_Data/ByCountry/{12 countries}/results/
     ├── Daily_Lineages_Freq_1_percent.csv                   (...)    - Frequency data
     ├── mutation_data/mutation_lists.csv                    (...)    - Mutations
     └── epitope_data/dms_per_ab_per_site.csv                (...)    - Escape scores

  CUDA Runtime:

  ✅ /usr/local/cuda-12.6/bin/nvcc                                    - Compiler
  ✅ /usr/local/cuda-12.6/lib64/libcudart.so                          - Runtime library
  ✅ /usr/local/cuda-12.6/lib64/libnvrtc.so                           - PTX JIT compiler

  ---
  SUMMARY: What Makes Stages 1-7 "Fully Functional"

  Required Files (All Present):

  1. ✅ CUDA Kernel: mega_fused_batch.cu with Stages 1-7 implemented
  2. ✅ PTX Binary: mega_fused_batch.ptx (compiled from .cu)
  3. ✅ Rust Launcher: mega_fused_batch.rs (loads PTX, launches kernel)
  4. ✅ Data Loaders: pdb_parser.rs, gpu_benchmark.rs, data_loader.rs
  5. ✅ Main Binary: vasil-benchmark (orchestrates everything)
  6. ✅ PDB Structure: spike_rbd_6m0j.pdb (real coordinates)
  7. ✅ VASIL CSVs: Frequencies, mutations, DMS scores (12 countries)

  Data Flow for Stages 1-7:

  PDB (6M0J) + Mutations → Mutated Coordinates → GPU
                                                ↓
  Conservation Scores (CPU) ────────────────→ GPU
  B-factors (from PDB) ──────────────────────→ GPU
  Burial Scores (CPU computed) ──────────────→ GPU
  Residue Types (from PDB) ──────────────────→ GPU (Stage 7!)
                                                ↓
                                      [GPU Stages 1-7]
                                      - Real distance matrix
                                      - Real contact graph
                                      - Real centrality
                                      - Real reservoir dynamics
                                      - Real consensus
                                      - Real fitness (from res_types)
                                                ↓
                                Features 0-95 (REAL) → CPU

  All data for Stages 1-7 is REAL and flows end-to-end from PDB → GPU → Results.
