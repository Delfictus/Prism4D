# PRISM-LBS Docker Compose Configuration
# For publication-ready reproducibility
#
# Usage:
#   docker-compose -f docker/docker-compose.yml up prism-detect
#   docker-compose -f docker/docker-compose.yml up prism-validate

version: '3.8'

services:
  # Main PRISM-LBS detection service
  prism-detect:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: runtime
    image: prism-lbs:1.0
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - PRISM_PTX_PATH=/app/kernels/ptx
      - PRISM_MODEL_PATH=/app/models
      - RUST_LOG=info
    volumes:
      - ../data:/data:ro
      - ../results:/results
    command: ["detect", "/data/structure.pdb", "--output", "/results/output.json"]

  # Benchmark validation service
  prism-validate:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: validation
    image: prism-lbs-validation:1.0
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - PRISM_PTX_PATH=/app/kernels/ptx
      - PRISM_MODEL_PATH=/app/models
      - RUST_LOG=info
    volumes:
      - ../benchmark:/app/benchmark
      - ../results:/results
    command: ["--all", "--output", "/results"]

  # CryptoBench-only validation
  prism-cryptobench:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: validation
    image: prism-lbs-validation:1.0
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ../benchmark:/app/benchmark
      - ../results:/results
    command: ["--benchmark", "cryptobench", "--output", "/results/cryptobench"]

  # LIGYSIS-only validation
  prism-ligysis:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: validation
    image: prism-lbs-validation:1.0
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ../benchmark:/app/benchmark
      - ../results:/results
    command: ["--benchmark", "ligysis", "--output", "/results/ligysis"]

  # ASBench-only validation
  prism-asbench:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: validation
    image: prism-lbs-validation:1.0
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ../benchmark:/app/benchmark
      - ../results:/results
    command: ["--benchmark", "asbench", "--output", "/results/asbench"]

  # Benchmark download service
  prism-download-benchmarks:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: validation
    image: prism-lbs-validation:1.0
    volumes:
      - ../benchmark:/app/benchmark
    entrypoint: ["python3", "/app/benchmark/download_benchmarks.py"]
    command: ["--all", "--output", "/app/benchmark"]

networks:
  default:
    driver: bridge
